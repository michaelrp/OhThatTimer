@page "/"
@using System.Timers


<div class="card text-center" style="width: 18rem;">
    <div class="card-header">
        Oh That Timer!
    </div>
    <div class="card-body">
        <div class="text-center">
            <h1 class="display-3">@_currentTime</h1>
        </div>
        <div class="d-flex justify-content-between">
            <button type="button" class="btn @(_isRunning ? "btn-danger" : "btn-primary")" @onclick="StartStop">
                @if (_isRunning)
                {
                    <span class="oi oi-media-stop"></span>@(" Stop")
                }
                else
                {
                    <span class="oi oi-media-play"></span>@(" Start")
                }
            </button>
            <button type="button" class="btn btn-secondary" @onclick="Reset">
                <span class="oi oi-reload"></span> Reset
            </button>
        </div>
    </div>
    <div class="card-footer text-muted">
        <button type="button" class="btn btn-secondary" disabled="@(_isRunning)" @onclick="ReverseDirection">
            <span class="oi @_directionClass"></span> @_directionLabel
        </button>
    </div>
</div>

@code {
    private string? _currentTime;
    Timer _timer = default;
    DateTime _startTime;
    TimeSpan _savedTime;
    TimeSpan _differenceTime;
    bool _isRunning;
    string _directionLabel = "Count Up";
    string _directionClass = "oi-arrow-top";

    protected override async Task OnInitializedAsync()
    {
        _currentTime = "0:00";

        _isRunning = false;
        _timer = new Timer(1000);
        _timer.Elapsed += async (sender, e) => await TimerTick(sender, e);
        _savedTime = GetTimeSpanFromInput(_currentTime);
        _differenceTime = new TimeSpan();
    }

    public void ReverseDirection()
    {
        if (_directionLabel == "Count Up")
        {
            _directionLabel = "Count Down";
            _directionClass = "oi-arrow-bottom";
        }
        else
        {
            _directionLabel = "Count Up";
            _directionClass = "oi-arrow-top";
        }
    }

    private TimeSpan GetTimeSpanFromInput(string input)
    {
        // This is the default value
        if (input == "0:00")
        {
            return new TimeSpan();
        }

        var hrs = 0;
        var min = 0;
        var sec = 0;

        var parts = input.Split(":");

        if (parts.Length == 1)
        {
            sec = int.Parse(parts[0]);
        }
        else if (parts.Length == 2)
        {
            min = int.Parse(parts[0]);
            sec = int.Parse(parts[1]);
        }
        else if (parts.Length == 3)
        {
            hrs = int.Parse(parts[0]);
            min = int.Parse(parts[1]);
            sec = int.Parse(parts[2]);
        }

        return new TimeSpan(hrs, min, sec);
    }

    private async Task TimerTick(object sender, ElapsedEventArgs e)
    {
        var updatedTime = DateTime.Now;
        _differenceTime = (updatedTime - _startTime) + _savedTime;
        var format = _differenceTime.Hours < 1 ? @"m\:ss" : @"h\:mm\:ss";
        _currentTime = _differenceTime.ToString(format);

        this.StateHasChanged();
        await Task.CompletedTask;
    }

    private void StartStop()
    {
        if (_isRunning)
        {
            _timer.Stop();
            _savedTime = _differenceTime;
            _isRunning = false;
        }
        else
        {
            _startTime = DateTime.Now;
            _timer.Start();
            _isRunning = true;
        }
    }

    private void Reset()
    {
        _timer.Stop();
        _savedTime = new TimeSpan();
        _differenceTime = new TimeSpan();
        _isRunning = false;
        _currentTime = "0.00";
    }
}